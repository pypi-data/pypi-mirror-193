apiVersion: flux-framework.org/v1alpha1
kind: MiniCluster

metadata:
  name: {{ minicluster.name }}
  namespace: {{ minicluster.namespace }}
spec:
  # localDeploy needs to be false
  localDeploy: {% if minicluster.local_deploy %}true{% else %}false{% endif %}

  # Number of pods to create for MiniCluster
  size: {{ minicluster.size }}
  tasks: {% if job.tasks %}{{ job.tasks }}{% else %}1{% endif %}

  # Disable verbose output
  {% if job.quiet or job.timed %}logging:
    {% if job.quiet %}quiet: true{% endif %}
    {% if job.timed %}timed: true{% endif %}{% endif %}

  # Optional credentials if running the flux restful api
  {% if job.token or job.user %}fluxRestful:
    {% if job.token %}token: "{{ job.token }}"{% endif %}
    {% if job.user %}username: "{{ job.user }}"{% endif %}{% endif %}

  # TODO add pod resources, if needed
  containers:
    - image: {{ job.image }}
      {% if job.workdir %}workingDir: {{ job.workdir }}{% endif %}
      {% if job.command %}command: {{ job.command }}{% endif %}
      {% if job.flux_option_flags %}fluxOptionFlags: "-ompi=openmpi@5"{% endif %}
      cores: {% if job.cores %}{{ job.cores }}{% else %}1{% endif %}
      {% if job.limits or job.resources %}resources:{% endif %}
        {% if job.limits %}limits:
          {% for limit in job.limits %}
            {{ limit[0] }}: {{ limit[1] }}
          {% endfor %}{% endif %}
        {% if job.requests %}requests:
          {% for limit in job.requests %}
            {{ limit[0] }}: {{ limit[1] }}
          {% endfor %}{% endif %}
      {% if job.pre_command %}preCommand: |
        {{ job.pre_command }}{% endif %}
