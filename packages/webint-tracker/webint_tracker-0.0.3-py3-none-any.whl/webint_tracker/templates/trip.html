$def with (locations)

<link rel=stylesheet href=https://unpkg.com/leaflet@1.7.1/dist/leaflet.css
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin="">
<script src=https://unpkg.com/leaflet@1.7.1/dist/leaflet.js
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>

<div id=map></div>

<style>
#map {
    height: 40em;
    width: 100%; }
.my-div-icon {
    background-color: #39f; }
</style>

<script>
$# $$.load(function() {
  function buildMap(x, y) {
    var mymap = L.map('map').setView([x, y], 13)

    L.tileLayer(
      'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}',
      {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw'
      }
    ).addTo(mymap)

    $for location in locations:
        $ current = location["location"]["current_location"]
        $ lat, lng = current["geometry"]["coordinates"]
        $ metadata = current["properties"]
        var marker = L.marker([$lng, $lat]).addTo(mymap)
        marker.bindPopup('<b>$metadata["timestamp"]</b><br>' +
                         'elevation: $metadata.get("altitude", "?") meters').openPopup()

    // var marker = L.marker([lat, lng]).addTo(mymap)
    // var circle = L.circle([51.508, -0.11], {
    //     color: 'red',
    //     fillColor: '#f03',
    //     fillOpacity: 0.5,
    //     radius: 500
    // }).addTo(mymap)
    // var polygon = L.polygon([
    //     [51.509, -0.08],
    //     [51.503, -0.06],
    //     [51.51, -0.047]
    // ]).addTo(mymap)

    // marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
    // circle.bindPopup("I am a circle.");
    // polygon.bindPopup("I am a polygon.");

    // var popup = L.popup()
    //   .setLatLng([51.5, -0.09])
    //   .setContent("I am a standalone popup.")
    //   .openOn(mymap)

    // var popup = L.popup();
    // function onMapClick(e) {
    //     popup
    //         .setLatLng(e.latlng)
    //         .setContent("You clicked the map at " + e.latlng.toString())
    //         .openOn(mymap);
    // }
    // mymap.on('click', onMapClick);
  }

  $ lat, lng = locations[0]["location"]["current_location"]["geometry"]["coordinates"]
  buildMap($lng, $lat)
$# })
</script>

$# XXX $for location in locations:
$# XXX     <pre>$pformat(list(dict(t) for t in trip))</pre>
